#!/bin/bash

function cargo_install() {
  local package_name=$1
  local exec_name=$2
  local version=$3
  shift 2

  if command -v $exec_name >/dev/null 2>&1; then
    local installed_version=`$exec_name --version | sed -E 's/[a-zA-Z_-]+ v?//g'`
    if [ "$installed_version" == "$version" ]; then
        echo "[cargo_install] $package_name $version is already installed at $(command -v $exec_name)"
    else
        echo "[cargo_install] Forcing install $package_name $version"
        cargo install $package_name --version $version --force $@
    fi
  else
    echo "[cargo_install] Installing $package_name $version"
    cargo install $package_name --version $version $@
  fi
}

sudo apt-get install postgresql postgresql-contrib libpq-dev

sudo -u postgres bash -c "psql -c \"CREATE USER mend_dev WITH CREATEDB PASSWORD 'mend_dev_pw';\""
cargo_install diesel_cli diesel 1.3.1 --no-default-features --features postgres
diesel setup
cargo build
cargo test
